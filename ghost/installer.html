<html>
	<head>
			<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
			<script src="/static/js/api.js"></script>
<script>
var _messages = [];

function sendMessage(msg) {
	_messages.push(msg);
	showMessages();
}

function showMessages() {

	let eleMsg = document.getElementById('_message');
	let msgs = _messages.map(msg => '<div>' + msg + '</div>');
	eleMsg.innerHTML = msgs.join('');
}


var token = '<%= token %>';
var image = '<%= image %>';
var id = '<%= id %>';
var name = '<%= name %>';
var price = 3.0;
var protocol = 'fastcgi';
var appZip = 'https://github.com/TryGhost/Ghost/releases/download/2.9.1/Ghost-2.9.1.zip';
//let packageFile = 'https://raw.githubusercontent.com/jaynsw/installer/master/ghost/2.9.1/package.json';
let appConfig = 'https://raw.githubusercontent.com/jaynsw/installer/master/ghost/2.9.1/config.production.json';
let appSQL = 'https://raw.githubusercontent.com/jaynsw/installer/master/ghost/2.9.1/ghost.sql';
					
					
function installer() {
	let slug = {id, name, image, protocol};
						
	let api = new API(token);
	api.createSlug(slug).then(saveData => {
		let slugID = id;
		return api.fetchSlugFile(slugID, appZip, '/').then(downloadData => {
			return api.createSlugMySQL(slugID).then(saveData => {
				return api.runSlugSQL(slugID, appSQL).then(runData => {
					return api.getSlugMySQL(slugID).then(metas => {
						let domainName = name;
						let hostMeta = metas.find(meta => meta.metaKey === 'host');
						let host = hostMeta ? hostMeta.metaValue : null;
						let userMeta = metas.find(meta => meta.metaKey === 'user');
						let user = userMeta ? userMeta.metaValue : null;
						let passwordMeta = metas.find(meta => meta.metaKey === 'password');
						let password = passwordMeta ? passwordMeta.metaValue : null;
						let databaseMeta = metas.find(meta => meta.metaKey === 'database');
						let database = databaseMeta ? databaseMeta.metaValue : null;
						if (user && password && database && host) {
							let model = {domainName, user, password, database: user, host};
							return api.composeSlugTextFile(slugID, appConfig, '/', model).then(genData => {
								return api.startupSlug(slugID);	
							});
						}
						throw 'ER_DBO_NOT_FOUND';
						
					});
				});
			});
		});
	}).catch(err => {
		console.log(err);
	});
};
					
					
</script>

	</head>
	<body>
		<button onclick='installer()'>Install</button>
	</body>
</html>


